<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css" />
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.rc.1/handlebars.min.js"></script>
    <script src="http://include.jaydata.org/datajs-1.0.3.min.js" type="text/javascript"></script>
    <script src="http://include.jaydata.org/jaydata.min.js" type="text/javascript"></script>
    <script src="http://include.jaydata.org/jaystorm-1.0.0.js"></script>
    <script src="http://include.jaydata.org/handlebars-adapter-0.9.0.js"></script> 

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>RNL Ping Pong Leaderboard</title>

    <script>
    $(function() {
        // this is your API key to access the pingpong service in the RNL Ping Pong application
        var apiKey = {
            ownerId: '99833845-15b4-46c1-8bcd-8efdff0cca8a',
            appId: '67328087-2d35-450f-a961-c08294e1bda1',
            serviceName: 'pingpong'
        };
        
        // initialize the connection to the pingpong service in the RNL Ping Pong application
        // credentials are optional, anonymous access used if omitted
        $data.initService(apiKey /*, credentials */).then(function(pingpong, factory, type){
            // "pingpong" is your data context
            // "factory" is a context factory method
            // "type" is your context type
            
            function show_users() {
              var users = pingpong.Users
                .orderByDescending("it.score");
              users.renderTo("#user-list");
              users.renderTo(".user-select", "replace", "User-Select");
            }

            show_users();

            function calculate_chance_of_winning(player1, player2) {
              return 1 / (1+Math.pow(10, (player2[1] - player1[1])/400));
            }

            function calculate_new_rating(player, is_winner) {
              return Math.round(parseInt(player[1]) + 32*(is_winner - player[2]));
            }

            $(document).delegate("#new-game", "submit", function() {
                var form = this,
                    winner = form.winner.value.split("-"),
                    loser = form.loser.value.split("-");

                winner[2] = calculate_chance_of_winning(winner, loser);
                loser[2] = calculate_chance_of_winning(loser, winner);

                winner[1] = calculate_new_rating(winner, 1);
                loser[1] = calculate_new_rating(loser, 0);

                pingpong.Users.single(
                  function (u) {
                      return u.id == this.id
                  }, {"id": winner[0]},
                  function (u) {
                      pingpong.Users.attach(u);
                      u.score = winner[1];
                      pingpong.Users.saveChanges(function () {
                          show_users();
                      });
                  });

                pingpong.Users.single(
                  function (u) {
                      return u.id == this.id
                  }, {"id": loser[0]},
                  function (u) {
                      pingpong.Users.attach(u);
                      u.score = loser[1];
                      pingpong.Users.saveChanges(function () {
                          show_users();
                      });
                  });
                  
                //pingpong.Users.saveChanges().then(show_users);
                //prevent form submit
                return false;
            });

            $(document).delegate("#new-player", "submit", function() {
                var form = this;
                
                pingpong.Users.add({
                    name: form.name.value,
                    score: 1500
                });
                  
                pingpong.Users.saveChanges().then(show_users);
                //prevent form submit
                return false;
            });
        }).fail(function(err){
            console.error('Connection failed.');
            console.error(err);
        });
    });
    </script>
  </head>

  <body>
  <div data-role="page">
    <div data-role="header">
      <h1>Ping Pong Leaderboard</h1>
    </div><!-- /header -->

    <div role="main" class="ui-content">
      <table data-role="table" data-mode="table" class="table-stroke">
       <thead>
         <tr>
           <th>Player</th>
           <th>Rating</th>
         </tr>
       </thead>
       <tbody id="user-list">
       </tbody>
      </table>
<br>
      <div class="ui-corner-all custom-corners">
        <div class="ui-bar ui-bar-a">
          <h3>Add Player</h3>
        </div>
        <div class="ui-body ui-body-a">
          <form id="new-player" data-ajax="false">
             <div>Name:</div>
             <input name="name" type="text"/><br />
             <input type="submit" value="Add Player" />   
          </form>
        </div>
      </div>
<br>
      <div class="ui-corner-all custom-corners">
        <div class="ui-bar ui-bar-a">
          <h3>New Game</h3>
        </div>
        <div class="ui-body ui-body-a">
          <form id="new-game" data-ajax="false">
             <div>Winner:</div>
             <select name="winner" class="user-select"></select><br />
             <div>Loser:</div>
             <select name="loser" class="user-select"></select><br />
             <input type="submit" value="Save Game" />   
         </form>
        </div>
      </div>
    </div><!-- /content -->
  </div>

    <script id="User" type="x-handlebars-template">
      <tr>
        <td>{{name}}</td> 
        <td>{{score}}</td>
      </td>
    </script>
    <script id="User-Select" type="x-handlebars-template">
      <option value="{{id}}-{{score}}">{{name}}</option>
    </script>
  </body>
</html>